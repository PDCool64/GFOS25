import{Q as B}from"./QSpinner-BFNwqP9i.js";import{c as L,b as k,Q as P,a as D}from"./QItemLabel-BeoSBhOt.js";import{Q as E}from"./QInput-D5AtLni6.js";import{Q as G}from"./QPopupProxy-5Umc2OVJ.js";import{a as J,b as W,c as X}from"./QLayout-C1-uemT3.js";import{Q as Y}from"./QPage-BKLxa5PZ.js";import{Q as Z,R as I}from"./QBtn-CpPlhTW9.js";import{c as ee,a as C,h as u,a7 as F,_ as N,w as O,r as S,v as y,f as g,z as M,F as H,x as V,m as r,a8 as te,d as b,j as m,B as j,u as p,n as Q,t as x}from"./index-BoGljDLN.js";import{g as ae}from"./vm-DK5zCSE4.js";import{g as T,p as se}from"./request-CTPT2BVh.js";import{a as $,b as ne}from"./token--ulPFVqS.js";import{l as A}from"./language-CpZRSw5K.js";import"./render-CABIAf-z.js";import"./use-dark-CpAO_YU6.js";import"./use-key-composition-ChOD7TKA.js";import"./focus-manager-BJWzFvJg.js";import"./QDialog-2jei2Dsv.js";import"./QMenu-DpO5IsqL.js";import"./format-BOf40pHW.js";const oe=ee({name:"QChatMessage",props:{sent:Boolean,label:String,bgColor:String,textColor:String,name:String,avatar:String,text:Array,stamp:String,size:String,labelHtml:Boolean,nameHtml:Boolean,textHtml:Boolean,stampHtml:Boolean},setup(a,{slots:n}){const o=C(()=>a.sent===!0?"sent":"received"),i=C(()=>`q-message-text-content q-message-text-content--${o.value}`+(a.textColor!==void 0?` text-${a.textColor}`:"")),c=C(()=>`q-message-text q-message-text--${o.value}`+(a.bgColor!==void 0?` text-${a.bgColor}`:"")),w=C(()=>"q-message-container row items-end no-wrap"+(a.sent===!0?" reverse":"")),h=C(()=>a.size!==void 0?`col-${a.size}`:""),d=C(()=>({msg:a.textHtml===!0?"innerHTML":"textContent",stamp:a.stampHtml===!0?"innerHTML":"textContent",name:a.nameHtml===!0?"innerHTML":"textContent",label:a.labelHtml===!0?"innerHTML":"textContent"}));function _(l){return n.stamp!==void 0?[l,u("div",{class:"q-message-stamp"},n.stamp())]:a.stamp?[l,u("div",{class:"q-message-stamp",[d.value.stamp]:a.stamp})]:[l]}function f(l,t){const s=t===!0?l.length>1?e=>e:e=>u("div",[e]):e=>u("div",{[d.value.msg]:e});return l.map((e,v)=>u("div",{key:v,class:c.value},[u("div",{class:i.value},_(s(e)))]))}return()=>{const l=[];n.avatar!==void 0?l.push(n.avatar()):a.avatar!==void 0&&l.push(u("img",{class:`q-message-avatar q-message-avatar--${o.value}`,src:a.avatar,"aria-hidden":"true"}));const t=[];n.name!==void 0?t.push(u("div",{class:`q-message-name q-message-name--${o.value}`},n.name())):a.name!==void 0&&t.push(u("div",{class:`q-message-name q-message-name--${o.value}`,[d.value.name]:a.name})),n.default!==void 0?t.push(f(ae(n.default()),!0)):a.text!==void 0&&t.push(f(a.text)),l.push(u("div",{class:h.value},t));const s=[];return n.label!==void 0?s.push(u("div",{class:"q-message-label"},n.label())):a.label!==void 0&&s.push(u("div",{class:"q-message-label",[d.value.label]:a.label})),s.push(u("div",{class:w.value},l)),u("div",{class:`q-message q-message-${o.value}`},s)}}}),R=F("accounts",{state:()=>({accounts:{}}),getters:{},actions:{async fetchAllAccounts(){const a=await T("/accounts/all");if(!a.ok)throw new Error("HTTP error, status = "+a.status);const n=await a.json();for(const o of n)this.accounts[o.id]=o}}}),z=$(),q=R(),U=F("message",{state:()=>({messages:{},chats:{}}),getters:{},actions:{async fetchMessages(){const a=await fetch(ne+"/messages");if(!a.ok)throw new Error("HTTP error, status = "+a.status);const n=await a.json();for(const o of n)this.messages[o.id]=o},async fetchChat(a){const n=await T("/messages/chat/"+z.account.id+"/"+a);if(!n.ok)throw new Error("HTTP error, status = "+n.status);const o=await n.json();o.sent.length===0&&o.received.length===0||(this.chats[a]=o,this.chats[a].id=a)},async fetchChatForced(a){const n=await T("/messages/chat/"+z.account.id+"/"+a);if(!n.ok)throw new Error("HTTP error, status = "+n.status);const o=await n.json();this.chats[a]=o,this.chats[a].id=a},async fetchChats(){console.log(q.accounts[0]),console.log("Fetching Chats"),console.log(q.accounts);for(const a in Object.values(q.accounts))this.fetchChat(a)}},persist:{enabled:!0,strategy:"local"}}),le={class:"q-pa-md column justify-center"},ce={style:{"margin-bottom":"20%",height:"80vh","overflow-y":"scroll"},id:"chat"},re={class:"input row",style:{"padding-bottom":"5px"}},ie={__name:"ChatComponent",props:{receiver:String},setup(a){const n=a;O(n.receiver,()=>{f()});const o=$(),i=U(),c=S([]),w=t=>{const s=new Date(t),e=s.getHours().toString().padStart(2,"0"),v=s.getMinutes().toString().padStart(2,"0");return e+":"+v},h=()=>{const t=document.getElementById("chat");t.scrollTop=t.scrollHeight},d=S(""),_=async()=>{const t=await se("/messages",{sender:o.account.id.toString(),receiver:""+n.receiver,content:d.value,timeSent:new Date().toISOString(),isReceived:!1,isRead:!1});console.log(t),t.ok&&(d.value="",f().finally(()=>{h()}),h()),await t.json()};console.log(n.receiver),console.log(o.account.id);const f=async()=>{i.fetchChatForced(n.receiver).finally(()=>{const t=i.chats[n.receiver];l(t.sent,t.received)})},l=(t,s)=>{for(let e=0;e<t.length;e++)t[e].sent=!0,t[e].content=[t[e].content];for(let e=0;e<s.length;e++)s[e].sent=!1,s[e].content=[s[e].content];c.value=t.concat(s),c.value.sort((e,v)=>new Date(e.timeSent)>new Date(v.timeSent)?1:-1);for(let e=0;e<c.value.length-1;e++){const v=new Date(c.value[e].timeSent),K=new Date(c.value[e+1].timeSent)-v;c.value[e].sent===c.value[e+1].sent&&K<3e5&&(c.value[e].content=c.value[e].content.concat(c.value[e+1].content),c.value.splice(e+1,1),e--)}};return i.chats[n.receiver]&&l(i.chats[n.receiver].sent,i.chats[n.receiver].received),f().finally(()=>{h()}),(t,s)=>(g(),y("div",le,[M("div",ce,[(g(!0),y(H,null,V(c.value,(e,v)=>(g(),y("div",{style:{width:"70%"},key:v},[r(oe,{text:e.content,sent:e.sent,name:e.sender.vorname+" "+e.sender.nachname,stamp:w(e.timeSent)},null,8,["text","sent","name","stamp"])]))),128))]),M("div",re,[r(E,{modelValue:d.value,"onUpdate:modelValue":s[0]||(s[0]=e=>d.value=e),onKeyup:te(_,["enter"]),placeholder:"Nachricht eingeben",dense:"",class:"col-11"},null,8,["modelValue"]),r(Z,{icon:"send",round:"",flat:"",onClick:_})])]))}},ue=N(ie,[["__scopeId","data-v-45fcf0d9"]]),me={key:0,class:"everything"},de={key:1},ve={__name:"ChatPage",setup(a){const n=S(-1),o=U(),i=R(),c=C(()=>{let l=[];for(const t in i.accounts)l.push(i.accounts[t]);return l}),w=S(c.value.slice(0,4));console.log(w.value);const h=S(""),d=S(!1);O(h,()=>{let l=[];for(let t=0;t<c.value.length;t++){let s=0;s+=100/.5+c.value[t].vorname.toLowerCase().indexOf(h.value.toLowerCase()),s+=100/.5+c.value[t].nachname.toLowerCase().indexOf(h.value.toLowerCase()),l.push([t,s-398])}l=l.filter(t=>t[1]!=0),l.sort((t,s)=>s[1]-t[1]),w.value=l.slice(0,5)}),i.fetchAllAccounts().then(async()=>{await o.fetchChats().then(()=>{console.log("Something worked")})});const _=S(!0),f=$();return(l,t)=>(g(),b(X,{view:"hhh lpR fFf"},{default:m(()=>[r(J,{"show-if-above":"",modelValue:_.value,"onUpdate:modelValue":t[3]||(t[3]=s=>_.value=s),side:"left",bordered:"",class:"drawer",style:{"overflow-y":"auto","max-height":"100vh"}},{default:m(()=>[r(L,null,{default:m(()=>[(g(!0),y(H,null,V(p(o).chats,s=>j((g(),b(k,{clickable:"",onClick:e=>n.value=s.id,key:s},{default:m(()=>[r(P,null,{default:m(()=>[r(D,null,{default:m(()=>{var e,v;return[r(B,{name:"person"}),Q(" "+x(((e=p(i).accounts[s.id])==null?void 0:e.vorname)+" "+((v=p(i).accounts[s.id])==null?void 0:v.nachname)),1)]}),_:2},1024)]),_:2},1024)]),_:2},1032,["onClick"])),[[I]])),128)),j((g(),b(k,{clickable:"",onClick:t[2]||(t[2]=s=>console.log("Click"))},{default:m(()=>[r(P,null,{default:m(()=>[r(D,null,{default:m(()=>[r(B,{name:"edit"}),Q(" "+x(p(A).chat_beginnen[p(f).sprache]),1)]),_:1})]),_:1}),r(G,{modelValue:d.value,"onUpdate:modelValue":t[1]||(t[1]=s=>d.value=s)},{default:m(()=>[r(L,null,{default:m(()=>[r(E,{type:"search",style:{padding:"0 16px"},placeholder:"Search...",modelValue:h.value,"onUpdate:modelValue":t[0]||(t[0]=s=>h.value=s)},null,8,["modelValue"]),(g(!0),y(H,null,V(w.value,s=>(g(),b(k,{clickable:"",style:{cursor:"pointer"},key:s,onClick:e=>(n.value=""+s[0],console.log("Something works"),d.value=!1)},{default:m(()=>[Q(x(p(i).accounts[s[0]].vorname)+" "+x(p(i).accounts[s[0]].nachname)+" "+x(s),1)]),_:2},1032,["onClick"]))),128))]),_:1})]),_:1},8,["modelValue"])]),_:1})),[[I]])]),_:1})]),_:1},8,["modelValue"]),r(W,null,{default:m(()=>[r(Y,{class:"q-pa-md"},{default:m(()=>[n.value!==-1?(g(),y("div",me,[r(ue,{receiver:n.value},null,8,["receiver"])])):(g(),y("div",de,x(p(A).chat_oeffnen[p(f).sprache]),1))]),_:1})]),_:1})]),_:1}))}},Pe=N(ve,[["__scopeId","data-v-a2908ad2"]]);export{Pe as default};
